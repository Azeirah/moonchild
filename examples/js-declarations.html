<!--
An extension that walks JavaScript ASTs, and for all nodes that
introduce a new lexical scope, annotates the node with information about
all declarations in that scope.
-->
<script>
(function() {
  var moonchild = Moonchild.registerExtension();

  moonchild.on('parse', function(ast) {
    // Returns true if the given node introduces a new scope.
    function isScopeNode(n) {
      return n.type == 'FunctionDeclaration' ||
             n.type == 'FunctionExpression' ||
             n.type == 'Program';
    }

    var scopes = [];
    Moonchild.traverse(ast.value()[0], {
      enter: function(node) {
        if (isScopeNode(node)) {
          var decl = {};
          moonchild.addExtras(node, { declarations: decl });
          scopes.push(decl);
        }
        if (node.id) {
          scopes[scopes.length - 1][node.id.name] = node.id;
        }
      },
      leave: function(node) {
        if (isScopeNode(node))
          scopes.pop();
      }
    });
  });

})();
</script>