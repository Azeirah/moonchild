// Generated by CoffeeScript 1.7.1
(function() {
  var ExtensionAPI, addHook, applySafely, createEditor, estraverse, getHookArgs, globalExtensions, globalHooks, hooksDo, onChange, parse, parser, registerExtension, _;

  parser = require('./metadata');

  estraverse = require('estraverse');

  _ = require('underscore');

  globalHooks = {};

  globalExtensions = {};

  ExtensionAPI = (function() {
    function ExtensionAPI() {
      this._id = _.uniqueId('ext-');
      globalExtensions[this._id] = this;
      this._hooks = {};
      this.on = _.partial(addHook, this._id, globalHooks);
    }

    ExtensionAPI.prototype.addWidget = function(pos, node, type) {
      return this.addExtras(node, {
        type: 'DisplayWidget',
        widgetType: type,
        widgetPos: pos
      });
    };

    ExtensionAPI.prototype.addExtras = function(node, data) {
      var key;
      node._extras || (node._extras = {});
      key = this._id + _.uniqueId('_');
      node._extras[key] = data;
    };

    ExtensionAPI.prototype.getExtras = function(node) {
      var _ref;
      return (_ref = node._extras) != null ? _ref[this._id] : void 0;
    };

    ExtensionAPI.prototype.findExtras = function(node, cond) {
      var predicate;
      if (node._extras) {
        predicate = _.isFunction(cond) ? cond : _.isObject(cond) ? function(node) {
          return _.findWhere([node], cond) != null;
        } : void 0;
        return _.find(node._extras, predicate);
      }
    };

    ExtensionAPI.prototype.BEFORE = 'before';

    ExtensionAPI.prototype.AFTER = 'after';

    ExtensionAPI.prototype.REPLACE = 'replace';

    return ExtensionAPI;

  })();

  addHook = function(id, hookState, hookName, func) {
    var hooks;
    if (id == null) {
      id = _.uniqueId('hook-');
    }
    hooks = hookState[hookName] != null ? hookState[hookName] : hookState[hookName] = {};
    if (hooks[id] == null) {
      hooks[id] = [];
    }
    hooks[id].push(func);
  };

  hooksDo = function(hook, iter) {
    return _.each(hook, function(hookFns, id) {
      return _.each(hookFns, function(fn) {
        return iter(fn, id);
      });
    });
  };

  registerExtension = function() {
    return new ExtensionAPI;
  };

  parse = function(hooks, source) {
    var hookArgs, tree;
    tree = parser.parse(source);
    hookArgs = getHookArgs(tree);
    hooksDo(globalHooks['parse'], function(func, id) {
      return applySafely(func, hookArgs);
    });
    return tree;
  };

  createEditor = function(el) {
    var editor;
    editor = CodeMirror.fromTextArea(el);
    editor.on('change', _.debounce(onChange, 250));
    editor.setValue(editor.getValue() + ' ');
    return editor;
  };

  getHookArgs = function(ast) {
    var nodes;
    nodes = [];
    estraverse.traverse(ast, {
      enter: function(node) {
        return nodes.push(node);
      }
    });
    return [_.chain(nodes), _.chain(ast.comments)];
  };

  applySafely = function(func, args) {
    var e;
    try {
      return func.apply(null, args);
    } catch (_error) {
      e = _error;
      return console.log(e.stack || e);
    }
  };

  onChange = function(cm, changeObj) {
    var e, hookArgs, tree;
    try {
      tree = parse(globalHooks, cm.getValue());
    } catch (_error) {
      e = _error;
      console.log(e);
      return;
    }
    hookArgs = getHookArgs(tree);
    hooksDo(globalHooks['display'], function(func, id) {
      return applySafely(func, hookArgs);
    });
    return hooksDo(globalHooks['render'], function(func, id) {
      return applySafely(func, hookArgs);
    });
  };

  module.exports = {
    createEditor: createEditor,
    on: _.partial(addHook, null, globalHooks),
    onChange: onChange,
    parse: parse,
    registerExtension: registerExtension,
    traverse: estraverse.traverse
  };

}).call(this);
